name: Deploy Azure Function App via ZipDeploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment zip
        run: |
          zip -r functionapp.zip . \
            -x ".git/*" ".github/*" "local.settings.json" ".venv/*" "__pycache__/*"

      - name: Deploy via ZipDeploy
        env:
          ZIP_HOST:     ${{ secrets.AZURE_ZIPDEPLOY_HOST }}
          ZIP_USERNAME: ${{ secrets.AZURE_ZIPDEPLOY_USERNAME }}
          ZIP_PASSWORD: ${{ secrets.AZURE_ZIPDEPLOY_PASSWORD }}
        run: |
          echo "Deploying to https://$ZIP_HOST/api/zipdeploy"

          STATUS_CODE=$(curl -s -o response.txt -w "%{http_code}" \
            -u "$ZIP_USERNAME:$ZIP_PASSWORD" \
            --data-binary @functionapp.zip \
            "https://$ZIP_HOST/api/zipdeploy")

          echo "ZipDeploy HTTP status: $STATUS_CODE"
          echo "---- ZipDeploy response ----"
          cat response.txt
          echo "----------------------------"

          if [ "$STATUS_CODE" -lt 200 ] || [ "$STATUS_CODE" -ge 300 ]; then
            echo "Deployment failed with status $STATUS_CODE"
            exit 1
          fi
