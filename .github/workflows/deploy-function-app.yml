name: Deploy Azure Function App via ZipDeploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment zip
        run: |
          zip -r functionapp.zip . \
            -x ".git/*" ".github/*" "local.settings.json" ".venv/*" "__pycache__/*"

      - name: Deploy via ZipDeploy
        env:
          ZIP_HOST:     ${{ secrets.AZURE_ZIPDEPLOY_HOST }}
          ZIP_USERNAME: ${{ secrets.AZURE_ZIPDEPLOY_USERNAME }}
          ZIP_PASSWORD: ${{ secrets.AZURE_ZIPDEPLOY_PASSWORD }}
        run: |
          curl -X POST \
            -u "$ZIP_USERNAME:$ZIP_PASSWORD" \
            --data-binary @functionapp.zip \
            "https://$ZIP_HOST/api/zipdeploy"
